name: Build Backstage Docker Image

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Yarn with Corepack
        run: |
          corepack enable
          corepack prepare yarn@stable --activate
          yarn -v

      - name: Install Dependencies
        run: yarn install --immutable

      - name: Type Check
        run: yarn tsc

      - name: Build Backend
        run: yarn build:backend

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        run: |
          docker buildx build . \
            -f packages/backend/Dockerfile \
            --tag myorg/backstage:latest \
            --load

      - name: Save Docker Image
        run: |
          mkdir -p docker-artifacts
          docker save myorg/backstage:latest -o docker-artifacts/backstage-image.tar
          gzip docker-artifacts/backstage-image.tar
          ls -lh docker-artifacts/

      - name: Upload Docker Image
        uses: actions/upload-artifact@v4
        with:
          name: backstage-docker-image-${{ github.sha }}
          path: docker-artifacts/backstage-image.tar.gz
          retention-days: 30

      - name: Build Summary
        run: |
          echo "=== Build Complete ==="
          echo "Docker Image: myorg/backstage:latest"
          echo "Artifact: backstage-image.tar.gz"
