name: Build & Deploy Backstage

on:
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write

jobs:
  build-backstage:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
#        with:
#          token: ${{ secrets.PAT_TOKEN }}
#          fetch-depth: 0

      - name: Setup Node.js  22
        uses: actions/setup-node@v4
        with:
          node-version:  '22'

      - name: Check installed tools
        run: |
            gcc --version
            g++ --version
            python3 --version
            make --version
      - name: Enable Corepack
        run: corepack enable
      - name: Enable Yarn 4.4.1
        run: |
          corepack enable
          corepack prepare yarn@4.4.1 --activate
          yarn -v
      # -------------------------
      # VERIFY DOCKER
      # -------------------------
      - name: Verify Docker
        run: |
          docker --version
          docker compose version || true
      # -------------------------
      # CREATE BACKSTAGE APP
      # -------------------------
      - name: Create Backstage App
        env:
          YARN_ENABLE_IMMUTABLE_INSTALLS: false
        run: |
          cd /tmp
          echo "my-backstage-app" | npx @backstage/create-app@latest
      # -------------------------
      # COPY BACKSTAGE APP â†’ REPO
      # -------------------------
      - name: Copy Backstage App Into Repo
        run: |
          rsync -av /tmp/my-backstage-app/ $GITHUB_WORKSPACE/ --exclude=.git
      # -------------------------
      # INSTALL DEPENDENCIES
      # -------------------------
      
      - name: Install Backstage Dependencies
        run: yarn install --frozen-lockfile
 
      # -------------------------
     
      
       
      # -------------------------
      # TYPE CHECK
      - name: Type Check
        run: yarn tsc


      # -------------------------
      # BUILD BACKEND
      - name: Build Backstage Backend
        run: yarn build:backend



      
   
