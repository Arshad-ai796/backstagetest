name: Build & Deploy Backstage

on:
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write

jobs:
  build-backstage:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js 18.20.5
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.5'

      # 3Ô∏è‚É£ Verify build tools
      - name: Check installed tools
        run: |
          gcc --version
          g++ --version
          python3 --version
          make --version

      # 4Ô∏è‚É£ Enable Corepack for Yarn
      - name: Enable Corepack
        run: corepack enable

      # 5Ô∏è‚É£ Create Backstage App (skip install)
      - name: Create Backstage App
        run: |
          echo "backstage-app" | npx -y @backstage/create-app@latest --skip-install

      # 6Ô∏è‚É£ Clean any previous Yarn artifacts
      - name: Clean Yarn
        working-directory: ./backstage-app
        run: |
          rm -rf node_modules .yarn/cache .yarn/unplugged .pnp.cjs
          rm -f yarn.lock

      # 7Ô∏è‚É£ Set Yarn version to 4.12.0
      - name: Setup Yarn 4.12.0
        working-directory: ./backstage-app
        run: |
          corepack enable
          yarn set version 4.12.0

      # 8Ô∏è‚É£ Fresh Yarn install
      - name: Yarn install
        working-directory: ./backstage-app
        run: yarn install --network-timeout 600000

      # 9Ô∏è‚É£ Build backend
      - name: Build Backend
        working-directory: ./backstage-app
        run: yarn build:backend

      # üîü Type check (optional, won't fail workflow)
      - name: Type Check
        working-directory: ./backstage-app
        run: yarn tsc --noEmit
        continue-on-error: true

      # 1Ô∏è‚É£1Ô∏è‚É£ Copy Backstage app into repo root
      - name: Copy Backstage App Into Repo
        run: |
          rsync -av ./backstage-app/ $GITHUB_WORKSPACE/ --exclude=.git
