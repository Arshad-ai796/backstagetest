
name: Build & Push Backstage

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  setup-environment:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # CHECKOUT
      - name: Checkout repository
        uses: actions/checkout@v4
     #   with:
     #     token: ${{ secrets.PAT_TOKEN }}
      #    persist-credentials: true

      # -------------------------
      # SETUP NODE (LTS Iron)
      - name: Setup Node.js LTS (Iron)
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/iron'
          cache: 'yarn'

      # -------------------------
      # ENABLE YARN 4.4.1 + force node-modules linker
      - name: Enable Yarn 4.4.1
        run: |
          set -euo pipefail
          corepack enable
          corepack prepare yarn@4.4.1 --activate
          yarn -v
          echo "YARN_NODE_LINKER=node-modules" >> $GITHUB_ENV
          echo "YARN_ENABLE_IMMUTABLE_INSTALLS=false" >> $GITHUB_ENV
          echo "YARN_NPM_REGISTRY_SERVER=https://registry.npmjs.org" >> $GITHUB_ENV
          echo "YARN_ENABLE_GLOBAL_CACHE=true" >> $GITHUB_ENV
          echo "YARN_GLOBAL_FOLDER=$HOME/.yarn/berry/cache" >> $GITHUB_ENV

      # -------------------------
      # VERIFY DOCKER (optional)
      - name: Verify Docker
        run: |
          set -euo pipefail
          docker --version
          docker compose version || true

      # -------------------------
      # CREATE BACKSTAGE APP (use a valid tag or latest)
      - name: Create Backstage App (0.7.5)
        run: |
          set -euo pipefail
          cd /tmp
          echo "Creating Backstage app..."
          npx --yes @backstage/create-app@0.7.5 \
            --path my-backstage-app \
            --skip-install \
            --no-private \
            --no-interactive
          echo "Backstage app scaffolded."

      # -------------------------
      # COPY SCAFFOLDED APP INTO WORKSPACE
      - name: Copy Backstage App to workspace
        run: |
          set -euo pipefail
          echo "Copying Backstage app to workspace..."
          if [ ! -d "/tmp/my-backstage-app" ]; then
            echo "‚ùå ERROR: /tmp/my-backstage-app does not exist"
            echo "Contents of /tmp:"
            ls -la /tmp
            exit 1
          fi
          rsync -a --delete --exclude=.git /tmp/my-backstage-app/ "$GITHUB_WORKSPACE/"

      # -------------------------
      # YARN SETTINGS (repo-level)
      - name: Configure Yarn in repo
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
          yarn config set nodeLinker node-modules
          yarn config set enableGlobalCache true
          yarn config set npmRegistryServer "https://registry.npmjs.org"
          yarn config set networkTimeout 600000
          yarn config set httpTimeout 600000

      # -------------------------
      # INSTALL DEPENDENCIES
      - name: Install Backstage Dependencies
        env:
          YARN_ENABLE_IMMUTABLE_INSTALLS: false
          YARN_NODE_LINKER: node-modules
        run: |
          set -euo pipefail
          yarn install --inline-builds

      # -------------------------
      # OPTIONAL: BUILD
      - name: Build Backstage
        run: |
          set -euo pipefail
          yarn tsc -b
         
