name: Build & Deploy Backstage

on:
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write

jobs:
  build-backstage:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
#        with:
#          token: ${{ secrets.PAT_TOKEN }}
#          fetch-depth: 0

      - name: Setup Node.js  18.20.5
        uses: actions/setup-node@v4
        with:
          node-version:  '18.20.5'

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3 make g++

      - name: Enable Corepack
        run: corepack enable

      - name: Create Backstage App with Skip Install
        run: |
          echo "backstage-app" | npx -y @backstage/create-app@latest --skip-install

      - name: Configure Yarn for CI
        working-directory: ./backstage-app
        run: |
          echo "enableImmutableInstalls: false" >> .yarnrc.yml
          cat .yarnrc.yml

      - name: Remove Problematic Dependencies
        working-directory: ./backstage-app
        run: |
          # Remove isolated-vm from package.json if it exists
          # This is often not needed for basic Backstage functionality
          if grep -q "isolated-vm" package.json; then
            echo "Removing isolated-vm dependency..."
            npm pkg delete dependencies.isolated-vm
          fi

      - name: Yarn install (immutable, skip builds)
        env:
                YARN_ENABLE_IMMUTABLE_INSTALLS: true
        run: |
              yarn --version
              yarn install --immutable --network-timeout 600000 --mode=skip-build
     
    
      - name: Type check
        run : yarn tsc --noEmit
        continue-on-error : true
       
      
      - name: Build Backstage backend
        run: yarn build:backend

      - name: Copy to Workspace Root
        run: |
          find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name 'backstage-app' -exec rm -rf {} +
          mv backstage-app/* .
          mv backstage-app/.* . 2>/dev/null || true
          rmdir backstage-app

     
