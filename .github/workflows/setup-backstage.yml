name: Backstage Setup - 

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      create_app:
        description: 'Create a test Backstage app'
        required: false
        type: boolean
        default: true
      app_name:
        description: 'Name for the Backstage app'
        required: false
        type: string
        default: 'my-backstage-app'
      build_docker:
        description: 'Build Docker image'
        required: false
        type: boolean
        default: true

jobs:
  backstage-setup:
    runs-on: ubuntu-latest
    
    env:
      NODE_VERSION: '20.19.6'
      APP_NAME: 'my-backstage-app'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js without cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: ''

      # ============================================
      # STEP 1: Check npm global root
      # ============================================
      - name: Step 1 - Check npm global root
        run: |
          echo "=== STEP 1: npm root -g ==="
          npm root -g
          echo ""

      # ============================================
      # STEP 2: List and check for create-app
      # ============================================
      - name: Step 2 - Check for create-app in bin directory
        run: |
          echo "=== STEP 2: ls -l bin | grep create-app ==="
          GLOBAL_PREFIX="$(npm config get prefix)"
          ls -l "$GLOBAL_PREFIX/bin" 2>/dev/null | grep create-app || echo "create-app not found (expected at this stage)"
          echo ""
        continue-on-error: true

      # ============================================
      # STEP 3: Verify Node and npm versions
      # ============================================
      - name: Step 3 - Verify Node and npm versions
        run: |
          echo "=== STEP 3: node -v && npm -v ==="
          echo "Node version:"
          node -v
          echo ""
          echo "npm version:"
          npm -v
          echo ""

      # ============================================
      # STEP 4: Get npm config prefix
      # ============================================
      - name: Step 4 - Get npm config prefix
        run: |
          echo "=== STEP 4: npm config get prefix ==="
          npm config get prefix
          echo ""

      # ============================================
      # CLEAN INSTALLATION PREPARATION
      # ============================================
      - name: Clean npm cache and remove old installations
        run: |
          echo "=== Cleaning npm cache ==="
          npm cache clean --force
          npm cache verify
          echo ""
          
          echo "=== Removing existing Backstage installations ==="
          npm uninstall -g @backstage/create-app 2>/dev/null || true
          npm uninstall -g @backstage/cli 2>/dev/null || true
          rm -rf $(npm root -g)/@backstage 2>/dev/null || true
          echo "âœ“ Cleanup complete"
          echo ""

      - name: Update npm to latest version
        run: |
          echo "=== Updating npm to latest ==="
          npm install -g npm@latest
          echo "Updated npm version:"
          npm -v
          echo ""

   
      - name: Step 5 - Install @backstage/create-app globally
        run: |
            printf "\n=== STEP 5: Installing @backstage/create-app globally ===\n"
            npm install -g @backstage/create-app@latest
            printf "\nâœ“ Installation complete\n"
            backstage --version


      # ============================================
      # STEP 6: Verify create-app installation
      # ============================================
      - name: Step 6 - Verify create-app installation
        run: |
          echo "=== STEP 6: ls -l bin | grep create-app ==="
          GLOBAL_PREFIX="$(npm config get prefix)"
          BIN_DIR="${GLOBAL_PREFIX}/bin"
          
          echo "Checking in: $BIN_DIR"
          ls -l "$BIN_DIR" | grep create-app || echo "create-app not found"
          echo ""
          
          echo "Installed @backstage/create-app package:"
          npm list -g @backstage/create-app --depth=0
          echo ""

      # ============================================
      # STEP 7: Setup NVM environment
      # ============================================
      - name: Step 7 - Verify NVM/Node setup
        run: |
          echo "=== STEP 7: NVM setup verification ==="
          echo "Note: GitHub Actions uses setup-node instead of NVM"
          echo ""
          echo "Node location: $(which node)"
          echo "Node version: $(node -v)"
          echo ""

      # ============================================
      # STEP 8: Verify node and npm locations
      # ============================================
      - name: Step 8 - Verify node and npm paths
        run: |
          echo "=== STEP 8: which node && which npm ==="
          echo "Node path:"
          which node
          echo ""
          echo "npm path:"
          which npm
          echo ""
          echo "Node version:"
          node -v
          echo ""
          echo "npm version:"
          npm -v
          echo ""

      # ============================================
      # STEP 9: Complete setup with PATH configuration
      # ============================================
      - name: Step 9 - Complete global setup and PATH configuration
        run: |
          echo "=== STEP 9: Complete setup with PATH ==="
          
          # Get the global npm prefix, then derive the bin directory
          GLOBAL_PREFIX="$(npm prefix -g)"
          BIN_DIR="${GLOBAL_PREFIX}/bin"
          
          echo "Global prefix: $GLOBAL_PREFIX"
          echo "Global bin:    $BIN_DIR"
          echo ""
          
          # Install Backstage CLI globally (creates the create-app binary in BIN_DIR)
          echo "Ensuring @backstage/create-app is installed..."
          npm install -g @backstage/create-app@latest --force
          echo ""
          
          # Add the bin to PATH for subsequent steps
          echo "$BIN_DIR" >> $GITHUB_PATH
          export PATH="$PATH:$BIN_DIR"
          
          # Verify
          echo "Verification:"
          which create-app || echo "create-app not on PATH yet"
          echo ""
          
          echo "Contents of $BIN_DIR:"
          ls -l "$BIN_DIR" | grep create-app || echo "create-app not found in $BIN_DIR"
          echo ""
          
          echo "Attempting to run create-app --version:"
          create-app --version 2>/dev/null || echo "Direct execution not available yet"
          echo ""

      # ============================================
      # STEP 10: Enable Corepack and install Yarn
      # ============================================
      - name: Step 10 - Setup Corepack and Yarn
        run: |
          echo "=== STEP 10: Enable Corepack and install Yarn ==="
          
          # Enable Corepack (comes with Node 20)
          echo "Enabling Corepack..."
          corepack enable
          echo ""
          
          # Install the latest stable Yarn
          echo "Installing latest stable Yarn..."
          corepack prepare yarn@stable --activate
          echo ""
          
          # Verify
          echo "Yarn version:"
          yarn -v
          echo ""

      # ============================================
      # STEP 11: Verify backstage-create-app
      # ============================================
      - name: Step 11 - Verify backstage-create-app
        run: |
          echo "=== STEP 11: Verify backstage-create-app ==="
          
          echo "Method 1 - Direct command:"
          backstage-create-app --version 2>/dev/null || echo "âœ— backstage-create-app command not available"
          echo ""
          
          echo "Method 2 - create-app command:"
          create-app --version 2>/dev/null || echo "âœ— create-app command not available"
          echo ""
          
          echo "Method 3 - npx (RECOMMENDED):"
          npx @backstage/create-app@latest --version
          echo ""

      # ============================================
      # VERSION VERIFICATION
      # ============================================
      - name: Verify latest version is installed
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     Version Verification               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          INSTALLED_VERSION=$(npm list -g @backstage/create-app --depth=0 2>/dev/null | grep @backstage/create-app | awk -F@ '{print $NF}' | tr -d ' ')
          echo "Installed version: $INSTALLED_VERSION"
          
          LATEST_VERSION=$(npm view @backstage/create-app version)
          echo "Latest available:  $LATEST_VERSION"
          echo ""
          
          if [ "$INSTALLED_VERSION" = "$LATEST_VERSION" ]; then
            echo "âœ“ SUCCESS: Latest version is installed!"
          else
            echo "âš  WARNING: Version mismatch detected"
            echo "  Installed: $INSTALLED_VERSION"
            echo "  Latest:    $LATEST_VERSION"
          fi
          echo ""

      # ============================================
      # CREATE BACKSTAGE APP
      # ============================================
      - name: Create Backstage App in /tmp
        if: github.event.inputs.create_app != 'false'
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     Creating Backstage App             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          APP_NAME="${{ github.event.inputs.app_name || env.APP_NAME }}"
          echo "Creating app: $APP_NAME in /tmp"
          echo ""
          
          cd /tmp
          
          # Use npx to ensure latest version
          npx --yes @backstage/create-app@latest --skip-install
          
          if [ -d "/tmp/$APP_NAME" ]; then
            echo "âœ“ App created successfully in /tmp/$APP_NAME"
            echo ""
            echo "App structure:"
            ls -la "/tmp/$APP_NAME"
            echo ""
          else
            echo "âœ— App creation failed"
            exit 1
          fi

      # ============================================
      # COPY BACKSTAGE APP â†’ REPO
      # ============================================
      - name: Copy Backstage App Into Repo
        if: github.event.inputs.create_app != 'false'
        run: |
          set -euo pipefail
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     Copying App to Repository          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          APP_NAME="${{ github.event.inputs.app_name || env.APP_NAME }}"
          
          echo "Copying /tmp/$APP_NAME to $GITHUB_WORKSPACE"
          rsync -a --delete --exclude='.git' "/tmp/$APP_NAME/" "$GITHUB_WORKSPACE/"
          
          echo ""
          echo "Repository contents:"
          ls -la "$GITHUB_WORKSPACE"
          echo ""
          echo "âœ“ App copied successfully"

      # ============================================
      # INSTALL DEPENDENCIES
      # ============================================
      - name: Install Backstage Dependencies
        if: github.event.inputs.create_app != 'false'
        env:
          YARN_ENABLE_IMMUTABLE_INSTALLS: false
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     Installing Dependencies            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          cd "$GITHUB_WORKSPACE"
          yarn install
          
          echo ""
          echo "âœ“ Dependencies installed successfully"

      # ============================================
      # TYPE CHECK
      # ============================================
      - name: Type Check
        if: github.event.inputs.create_app != 'false'
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     Running Type Check                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          cd "$GITHUB_WORKSPACE"
          yarn tsc
          
          echo ""
          echo "âœ“ Type check passed"

      # ============================================
      # BUILD BACKEND
      # ============================================
      - name: Build Backstage Backend
        if: github.event.inputs.create_app != 'false'
        run: |
          set -euo pipefail
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     Building Backend                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          cd "$GITHUB_WORKSPACE"
          yarn build:backend
          
          echo ""
          echo "âœ“ Backend built successfully"

      # ============================================
      # VERIFY BUNDLE EXISTS
      # ============================================
      - name: Verify backend bundle exists
        if: github.event.inputs.create_app != 'false'
        run: |
          set -euo pipefail
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     Verifying Backend Bundle           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          cd "$GITHUB_WORKSPACE"
          
          echo "Contents of packages/backend/dist:"
          ls -la packages/backend/dist || true
          echo ""
          
          if [[ ! -f packages/backend/dist/bundle.tar.gz ]]; then
            echo "âŒ ERROR: packages/backend/dist/bundle.tar.gz missing after build."
            echo "Check 'yarn build:backend' logs for errors."
            exit 1
          fi
          
          echo "âœ… Backend bundle verified"
          ls -lh packages/backend/dist/bundle.tar.gz

      # ============================================
      # SETUP DOCKER BUILDX
      # ============================================
      - name: Set up Docker Buildx
        if: github.event.inputs.build_docker != 'false'
        uses: docker/setup-buildx-action@v3

      # ============================================
      # BUILD DOCKER IMAGE
      # ============================================
      - name: Build Backstage Docker Image
        if: github.event.inputs.build_docker != 'false'
        working-directory: .
        run: |
          set -euo pipefail
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     Building Docker Image              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          if [[ ! -f packages/backend/Dockerfile ]]; then
            echo "âŒ ERROR: packages/backend/Dockerfile not found."
            exit 1
          fi
          
          echo "Building Docker image..."
          docker build -f packages/backend/Dockerfile -t myorg/backstage-app:latest .
          
          echo ""
          echo "âœ… Docker image built successfully"
          docker images | grep backstage

      # ============================================
      # SAVE DOCKER IMAGE AS TAR
      # ============================================
      - name: Save Docker image to tar
        if: github.event.inputs.build_docker != 'false'
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     Saving Docker Image                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          docker save myorg/backstage-app:latest -o backstage-image.tar
          
          echo ""
          echo "Image size:"
          ls -lh backstage-image.tar
          
          echo ""
          echo "âœ… Docker image saved to backstage-image.tar"

      # ============================================
      # UPLOAD DOCKER IMAGE ARTIFACT
      # ============================================
      - name: Upload Docker image artifact
        if: github.event.inputs.build_docker != 'false'
        uses: actions/upload-artifact@v4
        with:
          name: backstage-docker-image
          path: backstage-image.tar
          retention-days: 7
          compression-level: 0  # Already compressed

      # ============================================
      # UPLOAD BACKSTAGE APP ARTIFACT
      # ============================================
      - name: Upload Backstage App Source
        if: github.event.inputs.create_app != 'false'
        uses: actions/upload-artifact@v4
        with:
          name: backstage-app-source
          path: |
            ${{ github.workspace }}
            !${{ github.workspace }}/.git
            !${{ github.workspace }}/node_modules
            !${{ github.workspace }}/**/node_modules
          retention-days: 7

      # ============================================
      # COMMIT & PUSH CHANGES
      # ============================================
      - name: Commit and Push Changes
        if: github.event.inputs.create_app != 'false' && github.event_name != 'pull_request'
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     Committing Changes                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          cd "$GITHUB_WORKSPACE"
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "Staging all changes..."
          git add .
          
          echo ""
          echo "Changes to be committed:"
          git status --short
          
          echo ""
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes to commit"
          else
            echo "Committing changes..."
            git commit -m "Auto-generated Backstage app (latest version) [skip ci]"
            
            echo ""
            echo "Pushing to repository..."
            git push || echo "âš ï¸ Push failed or no changes to push"
            
            echo ""
            echo "âœ… Changes committed and pushed"
          fi

      # ============================================
      # FINAL SUMMARY
      # ============================================
      - name: Installation Summary
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                    â•‘"
          echo "â•‘     Backstage Installation Summary                â•‘"
          echo "â•‘                                                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ“ Node version:        $(node -v)"
          echo "âœ“ npm version:         $(npm -v)"
          echo "âœ“ Yarn version:        $(yarn -v)"
          echo "âœ“ Global npm prefix:   $(npm config get prefix)"
          echo ""
          echo "Backstage Installation:"
          npm list -g @backstage/create-app --depth=0 2>/dev/null || echo "  Not found via global install"
          echo ""
          echo "Latest available:      $(npm view @backstage/create-app version)"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "App Status:"
          if [ -f "$GITHUB_WORKSPACE/package.json" ]; then
            echo "  âœ… Backstage app created"
            echo "  ğŸ“¦ App name: $(cat $GITHUB_WORKSPACE/package.json | grep '"name"' | head -1 | awk -F'"' '{print $4}')"
            echo "  ğŸ“ Location: $GITHUB_WORKSPACE"
            
            if [ -f "$GITHUB_WORKSPACE/packages/backend/dist/bundle.tar.gz" ]; then
              echo "  âœ… Backend bundle built"
              echo "  ğŸ“¦ Bundle size: $(ls -lh $GITHUB_WORKSPACE/packages/backend/dist/bundle.tar.gz | awk '{print $5}')"
            fi
            
            if [ -f "$GITHUB_WORKSPACE/backstage-image.tar" ]; then
              echo "  âœ… Docker image created"
              echo "  ğŸ³ Image size: $(ls -lh $GITHUB_WORKSPACE/backstage-image.tar | awk '{print $5}')"
            fi
          else
            echo "  âš ï¸ No Backstage app in workspace"
          fi
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Artifacts:"
          echo "  ğŸ“¦ backstage-app-source (source code)"
          echo "  ğŸ³ backstage-docker-image (Docker image tar)"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Recommended Usage:"
          echo "  npx @backstage/create-app@latest"
          echo ""
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
